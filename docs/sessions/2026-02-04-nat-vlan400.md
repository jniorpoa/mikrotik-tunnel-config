# Sessão 2026-02-04 - NAT VLAN 400 para Câmera PTZ

## Resumo
Configuração de NAT no HEX-RJ para traduzir IP da câmera PTZ (172.16.40.3 → 10.39.2.1) permitindo acesso via VLAN 400 corporativa.

## Contexto
- O controlador PTZ no RJ precisa acessar a câmera usando o IP antigo (172.16.40.3) que circula na VLAN interna
- A câmera real está em Milão com IP 10.39.2.1
- O tráfego sai da ether4 do HEX-RJ → br06 → Core → SW andares → Controlador

## Infraestrutura RJ

```
CCR_ROUTER_1-BROADCAST (Gateway de todas VLANs)
         │
    Core1/Core2
         │
   ┌─────┴─────┐
   │  br01-06  │  (Switches de acesso)
   └─────┬─────┘
         │
   br06 porta 31 (VLAN 400 untagged)
         │
   HEX-RJ ether4 (172.16.40.3)
```

## Configurações Aplicadas no HEX-RJ

### 1. Renomear interface
```routeros
/interface ethernet set ether4 name=ether4-vlan400 comment="VLAN 400 - PTZ (br06 porta 31)"
```

### 2. IP na VLAN 400
```routeros
/ip address add address=172.16.40.3/24 interface=ether4-vlan400 comment="IP camera PTZ - NAT para Milao"
```

### 3. Regras de NAT
```routeros
# DST-NAT: quando acessar 172.16.40.3, redireciona para câmera real
/ip firewall nat add chain=dstnat dst-address=172.16.40.3 \
    action=dst-nat to-addresses=10.39.2.1 \
    comment="NAT camera PTZ Milao - traducao IP antigo"

# SRC-NAT: mascara origem para resposta voltar pelo túnel
/ip firewall nat add chain=srcnat dst-address=10.39.2.1 \
    action=src-nat to-addresses=10.255.255.1 \
    comment="SNAT camera PTZ - resposta via tunel"
```

### 4. Regra de Firewall
```routeros
/ip firewall filter add chain=input src-address=172.16.40.0/24 action=accept \
    comment="Aceita VLAN 400 - PTZ" place-before=0
```

## Troubleshooting Realizado

### Problema Inicial
- Ping do CCR para 172.16.40.3 dava timeout

### Diagnóstico
1. Verificado br06:
   - ether31 com PVID 400 ✅
   - VLAN 400 tagged nos uplinks ✅
   - Porta RUNNING ✅

2. Verificado HEX-RJ:
   - Interface ether4 UP com link 1Gbps ✅
   - IP 172.16.40.3/24 configurado ✅
   - Ping para gateway 172.16.40.1 funcionando ✅
   - ARP resolvendo ✅

### Causa
Firewall do HEX-RJ bloqueando tráfego de entrada da VLAN 400

### Solução
Adicionar regra de firewall aceitando src-address=172.16.40.0/24

## Testes Realizados

| Origem | Destino | Resultado |
|--------|---------|-----------|
| HEX-RJ | 172.16.40.1 (CCR) | ✅ OK |
| CCR | 172.16.40.3 (HEX-RJ) | ✅ OK |
| br06 | 172.16.40.3 | ❌ Timeout (esperado - switch L2 sem IP na VLAN) |

## Portas do HEX-RJ

| Porta | Nome | Uso | Status |
|-------|------|-----|--------|
| ether1 | ether1-wan | WAN IP público | ✅ Produção |
| ether2 | ether2-lan | LAN RJ | Disponível |
| ether3 | ether3-reserva | Reserva | Disponível |
| ether4 | ether4-vlan400 | VLAN 400 PTZ | ✅ Produção |
| ether5 | ether5-mgmt | Gerência TI | ✅ Produção |

## Validação Final

| Teste | Resultado |
|-------|-----------|
| Acesso web http://172.16.40.3 | ✅ Funcionando |
| Controle PTZ (TCP 80/443, UDP 52380) | ✅ Funcionando |
| Validação com Henrique | ✅ Aprovado |

## Arquivos Modificados
- `configs/rj/00-full-config.rsc` - Adicionado NAT e firewall VLAN 400
- `README.md` - Atualizado diagrama e tabelas
- `docs/CHANGELOG.md` - Entrada desta sessão
