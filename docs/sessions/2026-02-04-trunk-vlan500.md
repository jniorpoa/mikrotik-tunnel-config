# Sessao 2026-02-04 - Trunk VLAN 500 para Camera PTZ

## Resumo
Configuracao de trunk na ether4 do HEX-RJ para adicionar VLAN 500, permitindo acesso a camera PTZ pelo IP 172.16.50.171 (NAT para 10.39.2.1 em Milao).

## Contexto
- A camera PTZ ja era acessivel via VLAN 400 (172.16.40.3)
- Necessidade de acessar a mesma camera tambem pela rede 172.16.50.x (VLAN 500)
- Solucao: trunk na ether4 com VLAN 400 native + VLAN 500 tagged

## Topologia

```
Controlador (VLAN 500, 172.16.50.x)
        |
   Core / br06 porta 31 (trunk)
        |
   VLAN 500 tagged ──> vlan500-ptz (172.16.50.171)
   VLAN 400 native ──> ether4-vlan400 (172.16.40.3)
        |
   HEX-RJ ──> DST-NAT ──> WireGuard ──> HEX-MILAO ──> Camera (10.39.2.1)
```

## Configuracoes Aplicadas

### HEX-RJ

#### 1. Interface VLAN 500 (trunk sobre ether4)
```routeros
/interface vlan add name=vlan500-ptz vlan-id=500 interface=ether4-vlan400 \
    comment="VLAN 500 - PTZ rede 172.16.50.x (trunk ether4)"
```

#### 2. IP na VLAN 500
```routeros
/ip address add address=172.16.50.171/24 interface=vlan500-ptz \
    comment="IP camera PTZ - NAT para Milao (VLAN 500)"
```

#### 3. DST-NAT
```routeros
/ip firewall nat add chain=dstnat dst-address=172.16.50.171 action=dst-nat \
    to-addresses=10.39.2.1 comment="NAT camera PTZ Milao - VLAN 500"
```
> SRC-NAT existente ja cobre (match por dst-address=10.39.2.1)

#### 4. Firewall - Input
```routeros
/ip firewall filter add chain=input action=accept src-address=172.16.50.0/24 \
    comment="Aceita VLAN 500 - PTZ"
```

#### 5. Firewall - Forward
```routeros
/ip firewall filter add chain=forward action=accept \
    src-address=172.16.50.0/24 dst-address=10.39.2.0/24 \
    comment="VLAN 500 -> PTZ Milao via NAT"
/ip firewall filter add chain=forward action=accept \
    src-address=10.39.2.0/24 dst-address=172.16.50.0/24 \
    comment="PTZ Milao -> VLAN 500"
```

### Switch br06 (LMRJ-CPD-BR06)

#### Trunk na porta 31 - adicionar VLAN 500 tagged
```routeros
/interface bridge vlan set [find where vlan-ids=500 !dynamic] tagged=sfp-sfpplus1,sfp-sfpplus2,ether31
```
> PVID 400 mantido na porta (VLAN 400 continua native/untagged)

## Verificacoes

### HEX-RJ
| Teste | Resultado |
|-------|-----------|
| Ping 172.16.50.171 (local) | ✅ 0% loss |
| Interface vlan500-ptz | ✅ Running |
| NAT rule DST-NAT VLAN 500 | ✅ Presente (rule #2) |
| SRC-NAT existente | ✅ Cobre ambas VLANs |
| Firewall input VLAN 500 | ✅ Rule #17 |
| Firewall forward VLAN 500 | ✅ Rules #18-19 |

### br06
| Teste | Resultado |
|-------|-----------|
| VLAN 500 tagged na ether31 | Pendente - configurar trunk |

## Observacoes
- As regras de firewall da VLAN 500 ficaram apos as drop rules (9 e 16), mas como os drops sao especificos para in-interface=ether1-wan, trafego da VLAN 500 (que entra por vlan500-ptz) nao e afetado
- Para reordenar (opcional): `/ip firewall filter move 17 destination=1`

## Arquivos Modificados
- `configs/rj/00-full-config.rsc` - Adicionado VLAN 500, NAT e firewall
- `configs/rj/04-vlan500-nat.rsc` - Config incremental VLAN 500
- `README.md` - Atualizado diagrama e tabelas
- `docs/CHANGELOG.md` - Entrada desta sessao
